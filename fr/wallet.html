<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portefeuille - nova7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #10B981;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message-box.error {
            background-color: #EF4444;
        }
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }
        .sidebar-nova7 {
            width: 260px;
            background-color: white;
            height: 100vh;
            position: fixed;
            top: 0;
            left: -260px;
            transition: left 0.3s ease-in-out;
            z-index: 1000;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }
        .sidebar-nova7.open {
            left: 0;
        }
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #E5E7EB;
        }
        .sidebar-logo-img {
            width: 100px;
        }
        .nav-link-sidebar {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-link-sidebar i {
            margin-right: 0.75rem;
        }
        .nav-link-sidebar:hover {
            background-color: #F3F4F6;
            color: #0A66C2;
        }
        .nav-link-sidebar.active {
            background-color: #E0F2FE;
            color: #0A66C2;
            font-weight: 600;
        }
        .main-content-area {
            margin-left: 0;
            padding: 1rem;
            flex-grow: 1;
            transition: margin-left 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            .sidebar-nova7 {
                left: 0;
            }
            .main-content-area {
                margin-left: 260px;
            }
        }
        .desktop-header {
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .greeting-summary-card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .greeting-text {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
        }
        .ai-summary-text {
            color: #4B5563;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .card-styled {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
        }
        .card-content {
            display: none;
            padding-top: 1rem;
        }
        .card-content.open {
            display: block;
        }
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
            position: relative;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 0.875rem;
            color: #111827;
            background-color: #F9FAFB;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #0A66C2;
            box-shadow: 0 0 0 3px rgba(10, 102, 194, 0.1);
        }
        .btn-primary-action {
            background-color: #0A66C2;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary-action:hover {
            background-color: #0B5A9F;
        }
        .btn-primary-action:disabled {
            background-color: #6B7280;
            cursor: not-allowed;
        }
        .btn-secondary-action {
            background-color: #6B7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary-action:hover {
            background-color: #4B5563;
        }
        .btn-danger-action {
            background-color: #EF4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-danger-action:hover {
            background-color: #DC2626;
        }
        .tooltip {
            visibility: hidden;
            position: absolute;
            background-color: #374151;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            top: -2rem;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            z-index: 10;
        }
        .form-label:hover .tooltip {
            visibility: visible;
        }
        .balance-ring {
            width: 100px;
            height: 100px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .balance-display {
            font-size: 1.25rem;
            font-weight: 600;
            color: #0A66C2;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease-in-out;
        }
        .table-container {
            overflow-x: auto;
        }
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
        }
        .transaction-table th, .transaction-table td {
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem;
            color: #374151;
        }
        .transaction-table th {
            background-color: #F9FAFB;
            font-weight: 600;
        }
        .transaction-table td {
            border-bottom: 1px solid #E5E7EB;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .status-deposit {
            background-color: #D1FAE5;
            color: #10B981;
        }
        .status-withdrawal {
            background-color: #FEE2E2;
            color: #EF4444;
        }
        .status-transfer {
            background-color: #DBEAFE;
            color: #3B82F6;
        }
        .status-request {
            background-color: #FEF3C7;
            color: #D97706;
        }
        .status-completed {
            background-color: #D1FAE5;
            color: #10B981;
        }
        .status-pending {
            background-color: #FEF3C7;
            color: #D97706;
        }
        .status-failed {
            background-color: #FEE2E2;
            color: #EF4444;
        }
        .status-bill-payment {
            background-color: #EDE9FE;
            color: #7C3AED;
        }
        .status-cash-transfer {
            background-color: #E0F7FA;
            color: #00ACC1;
        }
        .suggestion-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #E5E7EB;
        }
        .suggestion-item:hover {
            background-color: #F3F4F6;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .recipient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #F3F4F6;
            border-radius: 6px;
        }
        .recipient-item button {
            color: #EF4444;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background-color: #FEE2E2;
        }
        .recipient-item button:hover {
            background-color: #FECACA;
        }
        .qr-scanner-container {
            display: none;
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            overflow: hidden;
        }
        .qr-scanner-container.active {
            display: block;
        }
        #qrVideo, #withdrawalQrVideo, #depositQrVideo, #qrDepositVideo, #qrWithdrawalVideo {
            width: 100%;
            height: auto;
        }
        .schedule-options {
            display: none;
        }
        .schedule-options.active {
            display: block;
        }
        .print-btn {
            cursor: pointer;
            color: #0A66C2;
            font-size: 0.765rem;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: #E0F2FE;
        }
        .print-btn:hover {
            background-color: #DBEAFE;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div id="messageBox" class="message-box"></div>

    <!-- Mobile Header -->
    <header class="mobile-header md:hidden">
        <button id="hamburgerBtnMobile" class="p-2 text-gray-700 hover:text-blue-600">
            <i class="fas fa-bars text-2xl"></i>
        </button>
        <a href="dashboard.html">
            <img src="nova-logo.png" alt="Logo nova7" class="nova7-logo-header"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
            <span style="display:none;" class="text-xl font-semibold text-gray-700">nova7</span>
        </a>
        <a href="#" id="mobileLogoutLink" class="p-2 text-gray-700 hover:text-blue-600">
            <i class="fas fa-sign-out-alt text-xl"></i>
        </a>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar-nova7">
        <div class="sidebar-header">
            <a href="dashboard.html" class="flex items-center">
                <img src="nova-logo.png" alt="Logo nova7" class="sidebar-logo-img"
                     onerror="this.style.display='none';">
            </a>
        </div>
        <nav class="flex-grow">
            <a href="dashboard.html" class="nav-link-sidebar"><i class="fas fa-tachometer-alt"></i>Tableau de bord</a>
            <a href="view-transactions.html" class="nav-link-sidebar"><i class="fas fa-exchange-alt"></i>Transactions</a>
            <a href="reports.html" class="nav-link-sidebar"><i class="fas fa-chart-pie"></i>Rapports</a>
            <a href="community.html" class="nav-link-sidebar"><i class="fas fa-users"></i>Communauté</a>
            <a href="chatbot.html" class="nav-link-sidebar"><i class="fas fa-comments-dollar"></i>Conseiller Chat</a>
            <a href="resources.html" class="nav-link-sidebar"><i class="fas fa-book-open"></i>Ressources</a>
            <a href="settings.html" class="nav-link-sidebar"><i class="fas fa-cog"></i>Paramètres</a>
            <a href="wallet.html" class="nav-link-sidebar active"><i class="fas fa-wallet"></i>Portefeuille</a>
            <a href="marketplace.html" class="nav-link-sidebar"><i class="fas fa-store"></i>Marketplace</a>
        </nav>
        <div class="pb-4">
            <a href="profile.html" class="nav-link-sidebar"><i class="fas fa-user-circle"></i>Profil</a>
            <a href="#" id="sidebarLogoutLink" class="nav-link-sidebar"><i class="fas fa-sign-out-alt"></i>Déconnexion</a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content-area">
        <header class="desktop-header hidden md:flex items-center justify-between mb-8">
            <div></div>
            <div class="flex items-center space-x-3">
                <span id="desktopUserWelcome" class="text-[0.867rem] text-gray-700">Bienvenue, Utilisateur !</span>
            </div>
        </header>

        <div class="greeting-summary-card">
            <h1 id="personalizedGreeting" class="greeting-text">Bonjour, Utilisateur !</h1>
            <p class="ai-summary-text" id="aiSummaryText">
                Gérez vos fonds, consultez votre solde et suivez vos transactions ci-dessous.
            </p>
        </div>

        <!-- Wallet Balance -->
        <div class="card-styled text-center">
            <h2 class="text-[1.02rem] font-semibold text-gray-700 mb-2">Solde actuel</h2>
            <div class="relative inline-block">
                <svg class="balance-ring" viewBox="0 0 36 36">
                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                          fill="none" stroke="#E0F2FE" stroke-width="2"/>
                    <path id="balanceProgress" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831"
                          fill="none" stroke="#0A66C2" stroke-width="2" stroke-dasharray="0, 100"/>
                </svg>
                <p id="walletBalance" class="balance-display">$0.00</p>
            </div>
            <div id="pendingRequestsSummary" class="text-[0.867rem] text-gray-600 mt-4 font-semibold">
                <p>Demandes entrantes : <span id="numPendingRequests" class="text-orange-500">0</span> (Total : <span id="totalPendingAmount" class="text-orange-500">$0.00</span>)</p>
                <button id="viewPendingRequestsBtn" class="text-blue-600 hover:underline text-[0.867rem] mt-1">Voir les détails</button>
            </div>
        </div>

        <!-- Pay Bill Section (All Users) -->
        <div class="card-styled">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Payer une facture</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="payBillForm">
                    <div class="mb-4 relative">
                        <label for="billBusinessPartner" class="form-label">Partenaire commercial
                            <span class="tooltip">Recherchez le partenaire commercial à payer</span>
                        </label>
                        <input type="text" id="billBusinessPartner" class="form-input" placeholder="Nom ou ID du partenaire commercial" required autocomplete="off">
                        <div id="businessPartnerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden"></div>
                    </div>
                    <div class="mb-4">
                        <label for="billServiceName" class="form-label">Nom du service
                            <span class="tooltip">Entrez le nom du service (ex., Électricité, Internet)</span>
                        </label>
                        <input type="text" id="billServiceName" class="form-input" placeholder="ex., Électricité" required>
                    </div>
                    <div class="mb-4">
                        <label for="billReferenceNumber" class="form-label">Numéro de référence (facultatif)
                            <span class="tooltip">Entrez un numéro de référence si requis</span>
                        </label>
                        <input type="text" id="billReferenceNumber" class="form-input" placeholder="ex., 123456789">
                    </div>
                    <div class="mb-4">
                        <label for="billAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant de la facture (minimum 0,01 $)</span>
                        </label>
                        <input type="number" id="billAmount" class="form-input" placeholder="ex., 50,00" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" id="payBillSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-file-invoice-dollar mr-2"></i>Payer la facture
                    </button>
                </form>
                <div id="payBillMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Retail Agent: Process Withdrawal -->
        <div id="retailAgentWithdrawalCard" class="card-styled hidden">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Traiter un retrait</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="retailAgentWithdrawalForm">
                    <div class="mb-4">
                        <label for="withdrawalQrCode" class="form-label">Code QR ou ID utilisateur
                            <span class="tooltip">Scannez le code QR ou entrez l'ID utilisateur</span>
                        </label>
                        <input type="text" id="withdrawalQrCode" class="form-input" placeholder="ID utilisateur ou scannez le code QR">
                        <button type="button" id="startWithdrawalQrScan" class="btn-secondary-action w-full mt-2">
                            <i class="fas fa-qrcode mr-2"></i>Scanner le code QR
                        </button>
                        <div id="withdrawalQrScanner" class="qr-scanner-container">
                            <video id="withdrawalQrVideo"></video>
                            <button type="button" id="stopWithdrawalQrScan" class="btn-danger-action w-full mt-2">
                                <i class="fas fa-times mr-2"></i>Arrêter le scan
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="retailWithdrawalAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à retirer (minimum 0,01 $)</span>
                        </label>
                        <input type="number" id="retailWithdrawalAmount" class="form-input" placeholder="ex., 50,00" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" id="retailWithdrawalSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-paper-plane mr-2"></i>Confirmer le retrait
                    </button>
                </form>
                <div id="retailWithdrawalMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Retail Agent: Process Deposit -->
        <div id="retailAgentDepositCard" class="card-styled hidden">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Traiter un dépôt</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="retailAgentDepositForm">
                    <div class="mb-4">
                        <label for="depositQrCode" class="form-label">Code QR ou ID utilisateur
                            <span class="tooltip">Scannez le code QR ou entrez l'ID utilisateur</span>
                        </label>
                        <input type="text" id="depositQrCode" class="form-input" placeholder="ID utilisateur ou scannez le code QR">
                        <button type="button" id="startDepositQrScan" class="btn-secondary-action w-full mt-2">
                            <i class="fas fa-qrcode mr-2"></i>Scanner le code QR
                        </button>
                        <div id="depositQrScanner" class="qr-scanner-container">
                            <video id="depositQrVideo"></video>
                            <button type="button" id="stopDepositQrScan" class="btn-danger-action w-full mt-2">
                                <i class="fas fa-times mr-2"></i>Arrêter le scan
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="retailDepositAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à déposer (minimum 0,01 $)</span>
                        </label>
                        <input type="number" id="retailDepositAmount" class="form-input" placeholder="ex., 50,00" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" id="retailDepositSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-money-bill-wave mr-2"></i>Confirmer le dépôt
                    </button>
                </form>
                <div id="retailDepositMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Individual/Company: QR Code Deposit -->
        <div id="qrDepositCard" class="card-styled hidden">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Déposer via code QR</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="qrDepositForm">
                    <div class="mb-4">
                        <label for="qrDepositAgentCode" class="form-label">Code QR ou ID de l'agent
                            <span class="tooltip">Scannez le code QR de l'agent ou entrez son ID</span>
                        </label>
                        <input type="text" id="qrDepositAgentCode" class="form-input" placeholder="ID de l'agent ou scannez le code QR">
                        <button type="button" id="startQrDepositScan" class="btn-secondary-action w-full mt-2">
                            <i class="fas fa-qrcode mr-2"></i>Scanner le code QR
                        </button>
                        <div id="qrDepositScanner" class="qr-scanner-container">
                            <video id="qrDepositVideo"></video>
                            <button type="button" id="stopQrDepositScan" class="btn-danger-action w-full mt-2">
                                <i class="fas fa-times mr-2"></i>Arrêter le scan
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="qrDepositAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à déposer (minimum 0,01 $)</span>
                        </label>
                        <input type="number" id="qrDepositAmount" class="form-input" placeholder="ex., 50,00" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" id="qrDepositSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-money-bill-wave mr-2"></i>Confirmer le dépôt
                    </button>
                </form>
                <div id="qrDepositMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Individual/Company: QR Code Withdrawal -->
        <div id="qrWithdrawalCard" class="card-styled hidden">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Retirer via code QR</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="qrWithdrawalForm">
                    <div class="mb-4">
                        <label for="qrWithdrawalAgentCode" class="form-label">Code QR ou ID de l'agent
                            <span class="tooltip">Scannez le code QR de l'agent ou entrez son ID</span>
                        </label>
                        <input type="text" id="qrWithdrawalAgentCode" class="form-input" placeholder="ID de l'agent ou scannez le code QR">
                        <button type="button" id="startQrWithdrawalScan" class="btn-secondary-action w-full mt-2">
                            <i class="fas fa-qrcode mr-2"></i>Scanner le code QR
                        </button>
                        <div id="qrWithdrawalScanner" class="qr-scanner-container">
                            <video id="qrWithdrawalVideo"></video>
                            <button type="button" id="stopQrWithdrawalScan" class="btn-danger-action w-full mt-2">
                                <i class="fas fa-times mr-2"></i>Arrêter le scan
                            </button>
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="qrWithdrawalAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à retirer (minimum 0,01 $)</span>
                        </label>
                        <input type="number" id="qrWithdrawalAmount" class="form-input" placeholder="ex., 50,00" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" id="qrWithdrawalSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-paper-plane mr-2"></i>Confirmer le retrait
                    </button>
                </form>
                <div id="qrWithdrawalMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Business Partner: Cash Transfer -->
        <div id="cashTransferCard" class="card-styled hidden">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Transfert de fonds</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="cashTransferForm">
                    <div class="mb-4">
                        <label for="cashTransferList" class="form-label">Liste des destinataires
                            <span class="tooltip">Ajoutez des utilisateurs à la liste de paiement</span>
                        </label>
                        <div id="recipientList" class="border border-gray-300 rounded-lg p-2 mb-2"></div>
                        <input type="text" id="cashTransferRecipient" class="form-input" placeholder="Rechercher un utilisateur par nom, email ou ID" autocomplete="off">
                        <div id="cashTransferSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden"></div>
                    </div>
                    <div class="mb-4">
                        <label for="cashTransferAmount" class="form-label">Montant par destinataire (USD)
                            <span class="tooltip">Entrez le montant à transférer à chaque destinataire</span>
                        </label>
                        <input type="number" id="cashTransferAmount" class="form-input" placeholder="ex., 100,00" step="0.01" min="0.01" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">
                            <input type="checkbox" id="schedulePayment" class="mr-2">
                            Programmer le paiement
                            <span class="tooltip">Cochez pour programmer le paiement à une date ultérieure</span>
                        </label>
                    </div>
                    <div id="scheduleOptions" class="schedule-options">
                        <div class="mb-4">
                            <label for="scheduleDate" class="form-label">Date du paiement
                                <span class="tooltip">Sélectionnez la date du paiement</span>
                            </label>
                            <input type="datetime-local" id="scheduleDate" class="form-input">
                        </div>
                        <div class="mb-4">
                            <label class="form-label">
                                <input type="checkbox" id="isRecurring" class="mr-2">
                                Paiement récurrent
                                <span class="tooltip">Cochez pour un paiement récurrent</span>
                            </label>
                        </div>
                        <div id="recurringOptions" class="mb-4 hidden">
                            <label for="recurrenceInterval" class="form-label">Intervalle de récurrence
                                <span class="tooltip">Sélectionnez la fréquence du paiement</span>
                            </label>
                            <select id="recurrenceInterval" class="form-select">
                                <option value="daily">Quotidien</option>
                                <option value="weekly">Hebdomadaire</option>
                                <option value="monthly">Mensuel</option>
                                <option value="yearly">Annuel</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" id="cashTransferSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-money-bill-transfer mr-2"></i>Confirmer le transfert
                    </button>
                </form>
                <div id="cashTransferMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Pending Requests -->
        <div id="pendingRequestsContainer" class="card-styled">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Demandes en attente</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div id="pendingRequestsContent" class="card-content"></div>
        </div>

        <!-- Deposit via Stripe -->
        <div class="card-styled">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Déposer des fonds (via Stripe)</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="depositForm">
                    <div class="mb-4">
                        <label for="depositAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à déposer (minimum 1,00 $)</span>
                        </label>
                        <input type="number" id="depositAmount" class="form-input" placeholder="ex., 50,00" step="0.01" min="1.00" required>
                    </div>
                    <div class="mb-4">
                        <label for="card-element" class="form-label">Carte de crédit ou de débit
                            <span class="tooltip">Entrez les détails de votre carte en toute sécurité via Stripe</span>
                        </label>
                        <div id="card-element"></div>
                        <div id="card-errors" role="alert" class="text-red-500 text-[0.867rem] mt-2"></div>
                    </div>
                    <button type="submit" id="depositSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-money-bill-wave mr-2"></i>Confirmer le dépôt
                    </button>
                </form>
                <div id="depositMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Transfer Funds -->
        <div class="card-styled">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Transférer des fonds</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="transferForm">
                    <div class="mb-4 relative">
                        <label for="transferRecipient" class="form-label">Nom d'utilisateur, ID utilisateur ou email du destinataire
                            <span class="tooltip">Rechercher par nom d'utilisateur, email ou ID utilisateur</span>
                        </label>
                        <input type="text" id="transferRecipient" class="form-input" placeholder="ex., John Doe, user@example.com, ou 1234567" required autocomplete="off">
                        <div id="recipientSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden"></div>
                    </div>
                    <div class="mb-4">
                        <label for="transferAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à transférer (minimum 0,01 $)</span>
                        </label>
                        <input type="number" id="transferAmount" class="form-input" placeholder="ex., 25,00" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" id="transferSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-paper-plane mr-2"></i>Confirmer le transfert
                    </button>
                </form>
                <div id="transferMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Request Money -->
        <div class="card-styled">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Demander de l'argent</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="requestForm">
                    <div class="mb-4 relative">
                        <label for="requestSender" class="form-label">Nom d'utilisateur, ID utilisateur ou email de l'expéditeur
                            <span class="tooltip">Recherchez l'utilisateur à qui demander de l'argent</span>
                        </label>
                        <input type="text" id="requestSender" class="form-input" placeholder="ex., John Doe, user@example.com, ou 7654321" required autocomplete="off">
                        <div id="senderSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg mt-1 hidden"></div>
                    </div>
                    <div class="mb-4">
                        <label for="requestAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à demander (minimum 0,01 $)</span>
                        </label>
                        <input type="number" id="requestAmount" class="form-input" placeholder="ex., 10,00" step="0.01" min="0.01" required>
                    </div>
                    <button type="submit" id="requestSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-hand-holding-usd mr-2"></i>Envoyer la demande
                    </button>
                </form>
                <div id="requestMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Withdraw Funds -->
        <div class="card-styled">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Retirer des fonds</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content">
                <form id="withdrawalForm">
                    <div class="mb-4">
                        <label for="withdrawalAmount" class="form-label">Montant (USD)
                            <span class="tooltip">Entrez le montant à retirer (minimum 1,00 $)</span>
                        </label>
                        <input type="number" id="withdrawalAmount" class="form-input" placeholder="ex., 20,00" step="0.01" min="1.00" required>
                    </div>
                    <div class="mb-4">
                        <label for="withdrawalMethod" class="form-label">Méthode de retrait
                            <span class="tooltip">Sélectionnez comment vous souhaitez recevoir vos fonds</span>
                        </label>
                        <select id="withdrawalMethod" class="form-select" required>
                            <option value="">Sélectionner une méthode</option>
                            <option value="bank_transfer">Virement bancaire</option>
                            <option value="mobile_money">Mobile Money</option>
                            <option value="office_withdrawal">Retrait au bureau</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="withdrawalAccount" class="form-label">Compte/Numéro de mobile/Référence
                            <span class="tooltip">Fournissez les détails de votre compte ou un numéro de référence</span>
                        </label>
                        <input type="text" id="withdrawalAccount" class="form-input" placeholder="Votre compte, numéro de mobile ou référence" required>
                    </div>
                    <button type="submit" id="withdrawalSubmitBtn" class="btn-primary-action w-full">
                        <i class="fas fa-paper-plane mr-2"></i>Confirmer le retrait
                    </button>
                </form>
                <div id="withdrawalMessage" class="text-[0.867rem] text-center mt-4"></div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="card-styled">
            <div class="card-header">
                <h2 class="text-[1.02rem] font-semibold text-gray-700">Transactions récentes du portefeuille</h2>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="card-content open">
                <div class="table-container">
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Montant</th>
                                <th>Description</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionHistoryTableBody">
                            <tr><td colspan="6" class="text-center text-gray-500 py-4">Chargement des transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="noTransactionsMessage" class="text-center text-gray-500 py-4 hidden text-[0.918rem]">Aucune transaction récente trouvée.</div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Supabase Configuration
            const SUPABASE_URL = 'https://nvxqorudztbpwyanakdj.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52eHFvcnVkenRicHd5YW5ha2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzOTk5NTQsImV4cCI6MjA2Nzk3NTk1NH0.XvITDAnpEkjQTh4SCVOfwGKsaANS6tp58Up37SXwYRw';
            const TRANSACTION_FEE_RATE = 0.001;

            // Initialize Supabase
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Initialize Stripe
            const stripe = Stripe('pk_live_51QlhX1DV4GGUfngRRIJi02QYB2pTZg2bbX9T4xwM0i6FflEPt2FtV7ydZfNks9I9vOAcmwsLGM1U7tzbpmaP454C00qsme0XJ8');
            const elements = stripe.elements();
            const cardElement = elements.create('card');
            cardElement.mount('#card-element');

            // UI Elements
            const messageBox = document.getElementById('messageBox');
            const walletBalanceElement = document.getElementById('walletBalance');
            const pendingRequestsContainer = document.getElementById('pendingRequestsContent');
            const numPendingRequests = document.getElementById('numPendingRequests');
            const totalPendingAmount = document.getElementById('totalPendingAmount');
            const transactionTableBody = document.getElementById('transactionHistoryTableBody');
            const noTransactionsMessage = document.getElementById('noTransactionsMessage');
            let userId = null;
            let userName = 'Utilisateur';
            let accountType = 'individual';
            let recipientList = [];

            // Authenticate User
            const { data: { user }, error: userError } = await supabase.auth.getUser();
            if (userError || !user) {
                console.error('Erreur d\'authentification :', userError?.message || 'Aucun utilisateur trouvé');
                showMessage('Veuillez vous connecter pour accéder à votre portefeuille.', 'error');
                window.location.href = 'login.html';
                return;
            }
            userId = user.id;

            // Fetch User Profile and Account Type
            try {
                const { data: profile, error: profileError } = await supabase
                    .from('users')
                    .select('full_name, email, account_type')
                    .eq('id', userId)
                    .maybeSingle();

                if (profileError) throw profileError;
                userName = profile?.full_name || profile?.email || 'Utilisateur';
                accountType = profile?.account_type || 'individual';

                // Update Greeting
                const greetingElement = document.getElementById('personalizedGreeting');
                const desktopUserWelcomeElement = document.getElementById('desktopUserWelcome');
                const currentHour = new Date().getHours();
                let timeOfDayGreeting = currentHour < 12 ? 'Bonjour' : currentHour < 18 ? 'Bon après-midi' : 'Bonsoir';
                if (greetingElement) greetingElement.textContent = `${timeOfDayGreeting}, ${userName}!`;
                if (desktopUserWelcomeElement) desktopUserWelcomeElement.textContent = `Bienvenue, ${userName}!`;

                // Show/Hide Sections Based on Account Type
                if (accountType === 'retail_agent') {
                    document.getElementById('retailAgentWithdrawalCard').classList.remove('hidden');
                    document.getElementById('retailAgentDepositCard').classList.remove('hidden');
                } else {
                    document.getElementById('qrDepositCard').classList.remove('hidden');
                    document.getElementById('qrWithdrawalCard').classList.remove('hidden');
                }
                if (accountType === 'business_partner') {
                    document.getElementById('cashTransferCard').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Erreur lors de la récupération du profil utilisateur :', error);
                showMessage('Échec du chargement du profil utilisateur.', 'error');
            }

            // Show Message Function
            function showMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.className = `message-box ${type === 'success' ? '' : 'error'} show`;
                setTimeout(() => messageBox.classList.remove('show'), 3000);
            }

            // Collapsible Card Headers
            document.querySelectorAll('.card-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const icon = header.querySelector('i');
                    content.classList.toggle('open');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });
            });

            // Sidebar Toggle
            const hamburgerBtnMobile = document.getElementById('hamburgerBtnMobile');
            const sidebar = document.getElementById('sidebar');
            if (hamburgerBtnMobile && sidebar) {
                hamburgerBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.toggle('open');
                });
                document.addEventListener('click', (e) => {
                    if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !hamburgerBtnMobile.contains(e.target)) {
                        sidebar.classList.remove('open');
                    }
                });
            }

            // Get Calculated Balance
            async function getCalculatedBalance() {
                try {
                    const { data, error } = await supabase
                        .from('user_balances')
                        .select('balance')
                        .eq('user_id', userId)
                        .single();
                    if (error) throw error;
                    return data ? parseFloat(data.balance) : 0;
                } catch (error) {
                    console.error('Erreur lors de la récupération du solde :', error.message);
                    showMessage('Erreur lors de la récupération du solde.', 'error');
                    return 0;
                }
            }

            // Handle Logout
            async function handleLogout() {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            }
            document.getElementById('sidebarLogoutLink').addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });
            document.getElementById('mobileLogoutLink').addEventListener('click', (e) => {
                e.preventDefault();
                handleLogout();
            });

            // Stripe Card Errors
            cardElement.addEventListener('change', function(event) {
                const displayError = document.getElementById('card-errors');
                displayError.textContent = event.error ? event.error.message : '';
            });

            // Debounce for Autocomplete
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // QR Code Scanning
            async function startQrScanner(videoElementId, inputElementId, stopButtonId) {
                try {
                    const video = document.getElementById(videoElementId);
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    video.play();
                    document.getElementById(videoElementId).parentElement.classList.add('active');

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    async function scan() {
                        if (video.readyState === video.HAVE_ENOUGH_DATA) {
                            canvas.height = video.videoHeight;
                            canvas.width = video.videoWidth;
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);
                            if (code) {
                                document.getElementById(inputElementId).value = code.data;
                                stopQrScanner(videoElementId, stopButtonId, stream);
                            } else {
                                requestAnimationFrame(scan);
                            }
                        } else {
                            requestAnimationFrame(scan);
                        }
                    }
                    requestAnimationFrame(scan);
                } catch (error) {
                    console.error('Erreur lors du démarrage du scanner QR :', error);
                    showMessage('Échec du démarrage du scanner QR. Veuillez vérifier les permissions de la caméra.', 'error');
                }
            }

            function stopQrScanner(videoElementId, stopButtonId, stream) {
                stream.getTracks().forEach(track => track.stop());
                document.getElementById(videoElementId).srcObject = null;
                document.getElementById(videoElementId).parentElement.classList.remove('active');
            }

            // QR Scanner Event Listeners
            document.getElementById('startWithdrawalQrScan')?.addEventListener('click', () => startQrScanner('withdrawalQrVideo', 'withdrawalQrCode', 'stopWithdrawalQrScan'));
            document.getElementById('stopWithdrawalQrScan')?.addEventListener('click', () => {
                const stream = document.getElementById('withdrawalQrVideo').srcObject;
                if (stream) stopQrScanner('withdrawalQrVideo', 'stopWithdrawalQrScan', stream);
            });
            document.getElementById('startDepositQrScan')?.addEventListener('click', () => startQrScanner('depositQrVideo', 'depositQrCode', 'stopDepositQrScan'));
            document.getElementById('stopDepositQrScan')?.addEventListener('click', () => {
                const stream = document.getElementById('depositQrVideo').srcObject;
                if (stream) stopQrScanner('depositQrVideo', 'stopDepositQrScan', stream);
            });
            document.getElementById('startQrDepositScan')?.addEventListener('click', () => startQrScanner('qrDepositVideo', 'qrDepositAgentCode', 'stopQrDepositScan'));
            document.getElementById('stopQrDepositScan')?.addEventListener('click', () => {
                const stream = document.getElementById('qrDepositVideo').srcObject;
                if (stream) stopQrScanner('qrDepositVideo', 'stopQrDepositScan', stream);
            });
            document.getElementById('startQrWithdrawalScan')?.addEventListener('click', () => startQrScanner('qrWithdrawalVideo', 'qrWithdrawalAgentCode', 'stopQrWithdrawalScan'));
            document.getElementById('stopQrWithdrawalScan')?.addEventListener('click', () => {
                const stream = document.getElementById('qrWithdrawalVideo').srcObject;
                if (stream) stopQrScanner('qrWithdrawalVideo', 'stopQrWithdrawalScan', stream);
            });

            // Fetch Wallet Balance
            async function fetchWalletBalance() {
                try {
                    const balance = await getCalculatedBalance();
                    walletBalanceElement.textContent = `$${balance.toFixed(2)}`;
                    walletBalanceElement.style.transform = 'scale(1.1)';
                    setTimeout(() => walletBalanceElement.style.transform = 'scale(1)', 300);
                    const balanceProgress = document.getElementById('balanceProgress');
                    const activityPercent = Math.min(Math.max(0, balance / 1000) * 100, 100);
                    balanceProgress.setAttribute('stroke-dasharray', `${activityPercent}, 100`);
                    document.getElementById('aiSummaryText').innerHTML = `Votre solde de portefeuille actuel est de <strong>$${balance.toFixed(2)}</strong>. Gérez vos fonds ci-dessous.`;
                } catch (error) {
                    console.error('Erreur lors de la récupération du solde :', error);
                    showMessage('Erreur réseau lors de la récupération du solde.', 'error');
                    walletBalanceElement.textContent = '$0.00';
                }
            }

            // Fetch Pending Requests
            async function fetchPendingRequests() {
                try {
                    const { data, error } = await supabase
                        .from('transactions')
                        .select('id, amount, transaction_type, description, status, created_at, user_id, service_name, reference_number')
                        .eq('recipient_id', userId)
                        .eq('transaction_type', 'money_request')
                        .eq('status', 'pending')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    const pendingRequests = data || [];
                    numPendingRequests.textContent = pendingRequests.length;
                    const total = pendingRequests.reduce((sum, req) => sum + parseFloat(req.amount), 0);
                    totalPendingAmount.textContent = `$${total.toFixed(2)}`;

                    if (pendingRequests.length === 0) {
                        pendingRequestsContainer.innerHTML = '<p class="text-gray-500 text-center">Aucune demande en attente.</p>';
                        return;
                    }

                    const senderIds = [...new Set(pendingRequests.map(req => req.user_id))];
                    const { data: users, error: userError } = await supabase
                        .from('users')
                        .select('id, full_name')
                        .in('id', senderIds);

                    if (userError) throw userError;

                    const userMap = users.reduce((map, user) => ({ ...map, [user.id]: user.full_name }), {});
                    pendingRequestsContainer.innerHTML = pendingRequests.map(req => `
                        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex justify-between items-center">
                            <div>
                                <p><strong>Montant :</strong> $${parseFloat(req.amount).toFixed(2)}</p>
                                <p><strong>De :</strong> ${userMap[req.user_id] || 'Inconnu'} (ID : ${req.user_id})</p>
                                <p><strong>Description :</strong> ${req.description || 'N/A'}</p>
                                ${req.service_name ? `<p><strong>Service :</strong> ${req.service_name}</p>` : ''}
                                ${req.reference_number ? `<p><strong>Référence :</strong> ${req.reference_number}</p>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button class="btn-primary-action text-xs px-3 py-1 accept-request-btn" data-request-id="${req.id}">
                                    <i class="fas fa-check mr-1"></i>Accepter
                                </button>
                                <button class="btn-danger-action text-xs px-3 py-1 delete-request-btn" data-request-id="${req.id}">
                                    <i class="fas fa-times mr-1"></i>Refuser
                                </button>
                            </div>
                        </div>
                    `).join('');

                    pendingRequestsContainer.querySelectorAll('.accept-request-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleAcceptRequest(btn.dataset.requestId));
                    });
                    pendingRequestsContainer.querySelectorAll('.delete-request-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleDeclineRequest(btn.dataset.requestId));
                    });
                } catch (error) {
                    console.error('Erreur lors de la récupération des demandes en attente :', error);
                    showMessage('Erreur réseau lors du chargement des demandes en attente.', 'error');
                    pendingRequestsContainer.innerHTML = '<p class="text-gray-500">Erreur réseau lors du chargement des demandes en attente.</p>';
                }
            }

            // Handle Accept Request
            async function handleAcceptRequest(requestId) {
                try {
                    const { data: request, error: fetchError } = await supabase
                        .from('transactions')
                        .select('amount, user_id, description')
                        .eq('id', requestId)
                        .eq('recipient_id', userId)
                        .eq('status', 'pending')
                        .single();

                    if (fetchError || !request) throw new Error('Demande non trouvée ou déjà traitée.');

                    const balance = await getCalculatedBalance();
                    if (balance < request.amount) {
                        showMessage('Solde insuffisant pour accepter la demande.', 'error');
                        return;
                    }

                    const netAmount = parseFloat(request.amount) * (1 - TRANSACTION_FEE_RATE);
                    const { error: updateError } = await supabase
                        .from('transactions')
                        .update({ status: 'completed' })
                        .eq('id', requestId);

                    if (updateError) throw updateError;

                    const { error: txError } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: userId,
                                amount: -request.amount,
                                transaction_type: 'transfer',
                                status: 'completed',
                                description: `Paiement pour demande : ${request.description || 'N/A'}`,
                                recipient_id: request.user_id,
                                created_at: new Date().toISOString()
                            },
                            {
                                user_id: request.user_id,
                                amount: netAmount,
                                transaction_type: 'transfer',
                                status: 'completed',
                                description: `Reçu de ${userName} pour demande : ${request.description || 'N/A'}`,
                                recipient_id: userId,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (txError) throw txError;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'transfer',
                            amount: request.amount,
                            status: 'completed',
                            description: `Paiement pour demande : ${request.description || 'N/A'}`
                        }
                    });

                    showMessage('Demande acceptée et fonds transférés.', 'success');
                    await Promise.all([fetchPendingRequests(), fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors de l\'acceptation de la demande :', error);
                    showMessage(`Échec de l\'acceptation : ${error.message}`, 'error');
                }
            }

            // Handle Decline Request
            async function handleDeclineRequest(requestId) {
                try {
                    const { error } = await supabase
                        .from('transactions')
                        .update({ status: 'failed' })
                        .eq('id', requestId)
                        .eq('recipient_id', userId)
                        .eq('status', 'pending');

                    if (error) throw error;

                    showMessage('Demande refusée.', 'success');
                    await fetchPendingRequests();
                } catch (error) {
                    console.error('Erreur lors du refus de la demande :', error);
                    showMessage(`Échec du refus : ${error.message}`, 'error');
                }
            }

            // Fetch Transaction History
            async function fetchTransactionHistory() {
                transactionTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-500 py-4">Chargement des transactions...</td></tr>';
                noTransactionsMessage.classList.add('hidden');

                try {
                    const { data, error } = await supabase
                        .from('transactions')
                        .select('id, amount, transaction_type, description, status, created_at, recipient_id, user_id, service_name, reference_number, scheduled_at, is_recurring, recurrence_interval')
                        .or(`user_id.eq.${userId},recipient_id.eq.${userId}`)
                        .order('created_at', { ascending: false })
                        .limit(50);

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        noTransactionsMessage.classList.remove('hidden');
                        transactionTableBody.innerHTML = '';
                        return;
                    }

                    const recipientIds = [...new Set(data.map(tx => tx.recipient_id).filter(id => id))];
                    const { data: users, error: userError } = await supabase
                        .from('users')
                        .select('id, full_name')
                        .in('id', recipientIds);

                    if (userError) throw userError;

                    const userMap = users.reduce((map, user) => ({ ...map, [user.id]: user.full_name }), {});
                    transactionTableBody.innerHTML = data.map(tx => {
                        const typeClass = {
                            'deposit': 'status-deposit',
                            'withdrawal': 'status-withdrawal',
                            'transfer': 'status-transfer',
                            'money_request': 'status-request',
                            'bill_payment': 'status-bill-payment',
                            'cash_transfer': 'status-cash-transfer'
                        }[tx.transaction_type.toLowerCase()] || '';
                        const statusClass = {
                            'completed': 'status-completed',
                            'pending': 'status-pending',
                            'failed': 'status-failed'
                        }[tx.status.toLowerCase()] || '';
                        const description = tx.recipient_id && userMap[tx.recipient_id]
                            ? `${tx.description || ''} (À : ${userMap[tx.recipient_id]})`
                            : tx.description || 'N/A';
                        return `
                            <tr>
                                <td>${new Date(tx.created_at).toLocaleDateString('fr-FR', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                                <td><span class="status-badge ${typeClass}">${tx.transaction_type.toUpperCase()}</span></td>
                                <td>$${parseFloat(tx.amount).toFixed(2)}</td>
                                <td>
                                    ${description}
                                    ${tx.service_name ? `<br><strong>Service :</strong> ${tx.service_name}` : ''}
                                    ${tx.reference_number ? `<br><strong>Référence :</strong> ${tx.reference_number}` : ''}
                                    ${tx.scheduled_at ? `<br><strong>Programmé :</strong> ${new Date(tx.scheduled_at).toLocaleDateString('fr-FR')}` : ''}
                                    ${tx.is_recurring ? `<br><strong>Récurrent :</strong> ${tx.recurrence_interval}` : ''}
                                </td>
                                <td><span class="status-badge ${statusClass}">${tx.status.toUpperCase()}</span></td>
                                <td>
                                    ${tx.transaction_type === 'money_request' && tx.status === 'pending' && tx.recipient_id === userId ?
                                        `<button class="btn-primary-action text-[0.765rem] px-2 py-1 accept-request-btn" data-request-id="${tx.id}"><i class="fas fa-check mr-1"></i>Accepter</button>
                                         <button class="btn-danger-action text-[0.765rem] px-2 py-1 delete-request-btn ml-1" data-request-id="${tx.id}"><i class="fas fa-times mr-1"></i>Refuser</button>`
                                        : `<button class="print-btn" data-transaction-id="${tx.id}"><i class="fas fa-print mr-1"></i>Imprimer</button>`
                                    }
                                </td>
                            </tr>
                        `;
                    }).join('');

                    transactionTableBody.querySelectorAll('.accept-request-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleAcceptRequest(btn.dataset.requestId));
                    });
                    transactionTableBody.querySelectorAll('.delete-request-btn').forEach(btn => {
                        btn.addEventListener('click', () => handleDeclineRequest(btn.dataset.requestId));
                    });
                    transactionTableBody.querySelectorAll('.print-btn').forEach(btn => {
                        btn.addEventListener('click', () => handlePrintTransaction(btn.dataset.transactionId));
                    });
                } catch (error) {
                    console.error('Erreur lors de la récupération de l\'historique des transactions :', error);
                    showMessage('Erreur réseau lors du chargement des transactions.', 'error');
                    transactionTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-red-500 py-4">Erreur réseau lors du chargement des transactions.</td></tr>';
                }
            }

            // Print Transaction
            async function handlePrintTransaction(transactionId) {
                try {
                    const { data, error } = await supabase
                        .from('transactions')
                        .select('id, amount, transaction_type, description, status, created_at, recipient_id, user_id, service_name, reference_number, scheduled_at, is_recurring, recurrence_interval')
                        .eq('id', transactionId)
                        .single();

                    if (error) throw error;

                    const recipientId = data.recipient_id;
                    let recipientName = 'N/A';
                    if (recipientId) {
                        const { data: recipient, error: recipientError } = await supabase
                            .from('users')
                            .select('full_name')
                            .eq('id', recipientId)
                            .single();
                        if (!recipientError) recipientName = recipient.full_name;
                    }

                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head><title>Reçu de transaction</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                .receipt { max-width: 600px; margin: auto; border: 1px solid #ccc; padding: 20px; }
                                h1 { text-align: center; }
                                p { margin: 10px 0; }
                            </style>
                            </head>
                            <body>
                                <div class="receipt">
                                    <h1>Reçu de transaction - nova7</h1>
                                    <p><strong>ID de transaction :</strong> ${data.id}</p>
                                    <p><strong>Date :</strong> ${new Date(data.created_at).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                                    <p><strong>Type :</strong> ${data.transaction_type.toUpperCase()}</p>
                                    <p><strong>Montant :</strong> $${parseFloat(data.amount).toFixed(2)}</p>
                                    <p><strong>Description :</strong> ${data.description || 'N/A'}</p>
                                    ${data.service_name ? `<p><strong>Service :</strong> ${data.service_name}</p>` : ''}
                                    ${data.reference_number ? `<p><strong>Référence :</strong> ${data.reference_number}</p>` : ''}
                                    ${data.scheduled_at ? `<p><strong>Programmé :</strong> ${new Date(data.scheduled_at).toLocaleDateString('fr-FR')}</p>` : ''}
                                    ${data.is_recurring ? `<p><strong>Récurrent :</strong> ${data.recurrence_interval}</p>` : ''}
                                    <p><strong>Statut :</strong> ${data.status.toUpperCase()}</p>
                                    <p><strong>Destinataire :</strong> ${recipientName}</p>
                                </div>
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                } catch (error) {
                    console.error('Erreur lors de l\'impression :', error);
                    showMessage('Erreur lors de l\'impression du reçu.', 'error');
                }
            }

            // Handle Business Partner Search
            const handleBusinessPartnerSearch = debounce(async function(event) {
                const query = event.target.value.trim();
                const suggestionsContainer = document.getElementById('businessPartnerSuggestions');
                if (query.length < 2) {
                    suggestionsContainer.classList.add('hidden');
                    suggestionsContainer.innerHTML = '';
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('id, business_name, email')
                        .eq('account_type', 'business_partner')
                        .or(`business_name.ilike.%${query}%,email.ilike.%${query}%,id.eq.${query}`)
                        .neq('id', userId)
                        .limit(5);

                    if (error) throw error;

                    suggestionsContainer.innerHTML = data.length ? data.map(user => `
                        <div class="suggestion-item flex items-center" data-id="${user.id}" data-name="${user.business_name}">
                            <i class="fas fa-building mr-2 text-gray-500"></i>
                            <div>${user.business_name} (ID : ${user.id}, Email : ${user.email})</div>
                        </div>
                    `).join('') : '<p class="p-2 text-gray-500">Aucun partenaire commercial trouvé.</p>';
                    suggestionsContainer.classList.remove('hidden');

                    suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.getElementById('billBusinessPartner').value = item.dataset.id;
                            suggestionsContainer.classList.add('hidden');
                        });
                    });
                } catch (error) {
                    console.error('Erreur lors de la recherche de partenaires commerciaux :', error);
                    showMessage('Erreur réseau lors du chargement des suggestions.', 'error');
                    suggestionsContainer.innerHTML = '<p class="p-2 text-gray-500">Erreur réseau.</p>';
                    suggestionsContainer.classList.remove('hidden');
                }
            }, 300);

            // Handle Recipient Search for Transfer
            const handleRecipientSearch = debounce(async function(event) {
                const query = event.target.value.trim();
                const suggestionsContainer = document.getElementById('recipientSuggestions');
                if (query.length < 2) {
                    suggestionsContainer.classList.add('hidden');
                    suggestionsContainer.innerHTML = '';
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('id, full_name, email')
                        .or(`full_name.ilike.%${query}%,email.ilike.%${query}%,id.eq.${query}`)
                        .neq('id', userId)
                        .limit(5);

                    if (error) throw error;

                    suggestionsContainer.innerHTML = data.length ? data.map(user => `
                        <div class="suggestion-item flex items-center" data-id="${user.id}" data-name="${user.full_name}">
                            <i class="fas fa-user mr-2 text-gray-500"></i>
                            <div>${user.full_name} (Email : ${user.email}, ID : ${user.id})</div>
                        </div>
                    `).join('') : '<p class="p-2 text-gray-500">Aucun utilisateur trouvé.</p>';
                    suggestionsContainer.classList.remove('hidden');

                    suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.getElementById('transferRecipient').value = item.dataset.id;
                            suggestionsContainer.classList.add('hidden');
                        });
                    });
                } catch (error) {
                    console.error('Erreur lors de la recherche d\'utilisateur :', error);
                    showMessage('Erreur réseau lors du chargement des suggestions.', 'error');
                    suggestionsContainer.innerHTML = '<p class="p-2 text-gray-500">Erreur réseau.</p>';
                    suggestionsContainer.classList.remove('hidden');
                }
            }, 300);

            // Handle Sender Search for Request
            const handleSenderSearch = debounce(async function(event) {
                const query = event.target.value.trim();
                const suggestionsContainer = document.getElementById('senderSuggestions');
                if (query.length < 2) {
                    suggestionsContainer.classList.add('hidden');
                    suggestionsContainer.innerHTML = '';
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('id, full_name, email')
                        .or(`full_name.ilike.%${query}%,email.ilike.%${query}%,id.eq.${query}`)
                        .neq('id', userId)
                        .limit(5);

                    if (error) throw error;

                    suggestionsContainer.innerHTML = data.length ? data.map(user => `
                        <div class="suggestion-item flex items-center" data-id="${user.id}" data-name="${user.full_name}">
                            <i class="fas fa-user mr-2 text-gray-500"></i>
                            <div>${user.full_name} (Email : ${user.email}, ID : ${user.id})</div>
                        </div>
                    `).join('') : '<p class="p-2 text-gray-500">Aucun utilisateur trouvé.</p>';
                    suggestionsContainer.classList.remove('hidden');

                    suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            document.getElementById('requestSender').value = item.dataset.id;
                            suggestionsContainer.classList.add('hidden');
                        });
                    });
                } catch (error) {
                    console.error('Erreur lors de la recherche d\'utilisateur :', error);
                    showMessage('Erreur réseau lors du chargement des suggestions.', 'error');
                    suggestionsContainer.innerHTML = '<p class="p-2 text-gray-500">Erreur réseau.</p>';
                    suggestionsContainer.classList.remove('hidden');
                }
            }, 300);

            // Handle Cash Transfer Recipient Search
            const handleCashTransferSearch = debounce(async function(event) {
                const query = event.target.value.trim();
                const suggestionsContainer = document.getElementById('cashTransferSuggestions');
                if (query.length < 2) {
                    suggestionsContainer.classList.add('hidden');
                    suggestionsContainer.innerHTML = '';
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('id, full_name, email')
                        .or(`full_name.ilike.%${query}%,email.ilike.%${query}%,id.eq.${query}`)
                        .neq('id', userId)
                        .limit(5);

                    if (error) throw error;

                    suggestionsContainer.innerHTML = data.length ? data.map(user => `
                        <div class="suggestion-item flex items-center" data-id="${user.id}" data-name="${user.full_name}">
                            <i class="fas fa-user mr-2 text-gray-500"></i>
                            <div>${user.full_name} (Email : ${user.email}, ID : ${user.id})</div>
                        </div>
                    `).join('') : '<p class="p-2 text-gray-500">Aucun utilisateur trouvé.</p>';
                    suggestionsContainer.classList.remove('hidden');

                    suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const recipientId = item.dataset.id;
                            const recipientName = item.dataset.name;
                            if (!recipientList.some(rec => rec.id === recipientId)) {
                                recipientList.push({ id: recipientId, name: recipientName });
                                updateRecipientList();
                            }
                            document.getElementById('cashTransferRecipient').value = '';
                            suggestionsContainer.classList.add('hidden');
                        });
                    });
                } catch (error) {
                    console.error('Erreur lors de la recherche d\'utilisateur :', error);
                    showMessage('Erreur réseau lors du chargement des suggestions.', 'error');
                    suggestionsContainer.innerHTML = '<p class="p-2 text-gray-500">Erreur réseau.</p>';
                    suggestionsContainer.classList.remove('hidden');
                }
            }, 300);

            // Update Recipient List for Cash Transfer
            function updateRecipientList() {
                const recipientListContainer = document.getElementById('recipientList');
                recipientListContainer.innerHTML = recipientList.length ? recipientList.map(rec => `
                    <div class="recipient-item">
                        <span>${rec.name} (ID : ${rec.id})</span>
                        <button type="button" class="remove-recipient" data-id="${rec.id}"><i class="fas fa-trash"></i> Supprimer</button>
                    </div>
                `).join('') : '<p class="text-gray-500">Aucun destinataire ajouté.</p>';

                recipientListContainer.querySelectorAll('.remove-recipient').forEach(btn => {
                    btn.addEventListener('click', () => {
                        recipientList = recipientList.filter(rec => rec.id !== btn.dataset.id);
                        updateRecipientList();
                    });
                });
            }

            // Schedule Payment Toggle
            const schedulePaymentCheckbox = document.getElementById('schedulePayment');
            const scheduleOptions = document.getElementById('scheduleOptions');
            const isRecurringCheckbox = document.getElementById('isRecurring');
            const recurringOptions = document.getElementById('recurringOptions');

            if (schedulePaymentCheckbox && scheduleOptions) {
                schedulePaymentCheckbox.addEventListener('change', () => {
                    scheduleOptions.classList.toggle('active', schedulePaymentCheckbox.checked);
                });
            }

            if (isRecurringCheckbox && recurringOptions) {
                isRecurringCheckbox.addEventListener('change', () => {
                    recurringOptions.classList.toggle('hidden', !isRecurringCheckbox.checked);
                });
            }

            // Form Submissions
            async function handlePayBillForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('payBillSubmitBtn');
                submitBtn.disabled = true;
                const businessPartnerId = document.getElementById('billBusinessPartner').value;
                const serviceName = document.getElementById('billServiceName').value;
                const referenceNumber = document.getElementById('billReferenceNumber').value;
                const amount = parseFloat(document.getElementById('billAmount').value);
                const messageDiv = document.getElementById('payBillMessage');

                if (!businessPartnerId || !amount || amount < 0.01) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const balance = await getCalculatedBalance();
                    if (balance < amount) {
                        showMessage('Solde insuffisant pour effectuer ce paiement.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const netAmount = amount * (1 - TRANSACTION_FEE_RATE);
                    const { error } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: userId,
                                amount: -amount,
                                transaction_type: 'bill_payment',
                                status: 'completed',
                                description: `Paiement de facture à ${businessPartnerId} pour ${serviceName}`,
                                recipient_id: businessPartnerId,
                                service_name: serviceName,
                                reference_number: referenceNumber || null,
                                created_at: new Date().toISOString()
                            },
                            {
                                user_id: businessPartnerId,
                                amount: netAmount,
                                transaction_type: 'bill_payment',
                                status: 'completed',
                                description: `Paiement reçu de ${userName} pour ${serviceName}`,
                                recipient_id: userId,
                                service_name: serviceName,
                                reference_number: referenceNumber || null,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'bill_payment',
                            amount: amount,
                            status: 'completed',
                            description: `Paiement de facture à ${businessPartnerId} pour ${serviceName}`,
                            service_name: serviceName,
                            reference_number: referenceNumber
                        }
                    });

                    showMessage('Paiement de facture effectué avec succès !', 'success');
                    messageDiv.textContent = 'Paiement effectué avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('payBillForm').reset();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du paiement de la facture :', error);
                    showMessage(`Échec du paiement : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du paiement : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleRetailAgentWithdrawalForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('retailWithdrawalSubmitBtn');
                submitBtn.disabled = true;
                const userCode = document.getElementById('withdrawalQrCode').value;
                const amount = parseFloat(document.getElementById('retailWithdrawalAmount').value);
                const messageDiv = document.getElementById('retailWithdrawalMessage');

                if (!userCode || !amount || amount < 0.01) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const { data: recipient, error: userError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('id', userCode)
                        .single();

                    if (userError || !recipient) {
                        showMessage('Utilisateur non trouvé.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const balance = await getCalculatedBalance();
                    if (balance < amount) {
                        showMessage('Solde insuffisant pour effectuer ce retrait.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const netAmount = amount * (1 - TRANSACTION_FEE_RATE);
                    const { error } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: recipient.id,
                                amount: -amount,
                                transaction_type: 'withdrawal',
                                status: 'completed',
                                description: `Retrait traité par l\'agent ${userName}`,
                                recipient_id: userId,
                                created_at: new Date().toISOString()
                            },
                            {
                                user_id: userId,
                                amount: netAmount,
                                transaction_type: 'withdrawal',
                                status: 'completed',
                                description: `Retrait pour l\'utilisateur ${recipient.id}`,
                                recipient_id: recipient.id,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'withdrawal',
                            amount: amount,
                            status: 'completed',
                            description: `Retrait traité pour l\'utilisateur ${recipient.id}`
                        }
                    });

                    showMessage('Retrait traité avec succès !', 'success');
                    messageDiv.textContent = 'Retrait traité avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('retailAgentWithdrawalForm').reset();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du traitement du retrait :', error);
                    showMessage(`Échec du retrait : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du retrait : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleRetailAgentDepositForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('retailDepositSubmitBtn');
                submitBtn.disabled = true;
                const userCode = document.getElementById('depositQrCode').value;
                const amount = parseFloat(document.getElementById('retailDepositAmount').value);
                const messageDiv = document.getElementById('retailDepositMessage');

                if (!userCode || !amount || amount < 0.01) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const { data: recipient, error: userError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('id', userCode)
                        .single();

                    if (userError || !recipient) {
                        showMessage('Utilisateur non trouvé.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const { error } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: userId,
                                amount: -amount,
                                transaction_type: 'deposit',
                                status: 'completed',
                                description: `Dépôt traité pour l\'utilisateur ${recipient.id}`,
                                recipient_id: recipient.id,
                                created_at: new Date().toISOString()
                            },
                            {
                                user_id: recipient.id,
                                amount: amount,
                                transaction_type: 'deposit',
                                status: 'completed',
                                description: `Dépôt reçu de l\'agent ${userName}`,
                                recipient_id: userId,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'deposit',
                            amount: amount,
                            status: 'completed',
                            description: `Dépôt traité pour l\'utilisateur ${recipient.id}`
                        }
                    });

                    showMessage('Dépôt traité avec succès !', 'success');
                    messageDiv.textContent = 'Dépôt traité avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('retailAgentDepositForm').reset();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du traitement du dépôt :', error);
                    showMessage(`Échec du dépôt : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du dépôt : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleQrDepositForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('qrDepositSubmitBtn');
                submitBtn.disabled = true;
                const agentCode = document.getElementById('qrDepositAgentCode').value;
                const amount = parseFloat(document.getElementById('qrDepositAmount').value);
                const messageDiv = document.getElementById('qrDepositMessage');

                if (!agentCode || !amount || amount < 0.01) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const { data: agent, error: agentError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('id', agentCode)
                        .eq('account_type', 'retail_agent')
                        .single();

                    if (agentError || !agent) {
                        showMessage('Agent non trouvé.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const { error } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: userId,
                                amount: amount,
                                transaction_type: 'deposit',
                                status: 'completed',
                                description: `Dépôt via l\'agent ${agent.id}`,
                                recipient_id: agent.id,
                                created_at: new Date().toISOString()
                            },
                            {
                                user_id: agent.id,
                                amount: -amount,
                                transaction_type: 'deposit',
                                status: 'completed',
                                description: `Dépôt traité pour l\'utilisateur ${userName}`,
                                recipient_id: userId,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'deposit',
                            amount: amount,
                            status: 'completed',
                            description: `Dépôt via l\'agent ${agent.id}`
                        }
                    });

                    showMessage('Dépôt effectué avec succès !', 'success');
                    messageDiv.textContent = 'Dépôt effectué avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('qrDepositForm').reset();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du dépôt :', error);
                    showMessage(`Échec du dépôt : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du dépôt : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleQrWithdrawalForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('qrWithdrawalSubmitBtn');
                submitBtn.disabled = true;
                const agentCode = document.getElementById('qrWithdrawalAgentCode').value;
                const amount = parseFloat(document.getElementById('qrWithdrawalAmount').value);
                const messageDiv = document.getElementById('qrWithdrawalMessage');

                if (!agentCode || !amount || amount < 0.01) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const { data: agent, error: agentError } = await supabase
                        .from('users')
                        .select('id')
                        .eq('id', agentCode)
                        .eq('account_type', 'retail_agent')
                        .single();

                    if (agentError || !agent) {
                        showMessage('Agent non trouvé.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const balance = await getCalculatedBalance();
                    if (balance < amount) {
                        showMessage('Solde insuffisant pour effectuer ce retrait.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const netAmount = amount * (1 - TRANSACTION_FEE_RATE);
                    const { error } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: userId,
                                amount: -amount,
                                transaction_type: 'withdrawal',
                                status: 'completed',
                                description: `Retrait via l\'agent ${agent.id}`,
                                recipient_id: agent.id,
                                created_at: new Date().toISOString()
                            },
                            {
                                user_id: agent.id,
                                amount: netAmount,
                                transaction_type: 'withdrawal',
                                status: 'completed',
                                description: `Retrait traité pour l\'utilisateur ${userName}`,
                                recipient_id: userId,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'withdrawal',
                            amount: amount,
                            status: 'completed',
                            description: `Retrait via l\'agent ${agent.id}`
                        }
                    });

                    showMessage('Retrait effectué avec succès !', 'success');
                    messageDiv.textContent = 'Retrait effectué avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('qrWithdrawalForm').reset();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du retrait :', error);
                    showMessage(`Échec du retrait : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du retrait : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleCashTransferForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('cashTransferSubmitBtn');
                submitBtn.disabled = true;
                const amount = parseFloat(document.getElementById('cashTransferAmount').value);
                const scheduleDate = document.getElementById('scheduleDate').value;
                const isRecurring = document.getElementById('isRecurring').checked;
                const recurrenceInterval = document.getElementById('recurrenceInterval').value;
                const messageDiv = document.getElementById('cashTransferMessage');

                if (!recipientList.length || !amount || amount < 0.01) {
                    showMessage('Veuillez ajouter au moins un destinataire et un montant valide.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const balance = await getCalculatedBalance();
                    if (balance < amount * recipientList.length) {
                        showMessage('Solde insuffisant pour effectuer ce transfert.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const transactions = [];
                    const netAmount = amount * (1 - TRANSACTION_FEE_RATE);
                    for (const recipient of recipientList) {
                        transactions.push(
                            {
                                user_id: userId,
                                amount: -amount,
                                transaction_type: 'cash_transfer',
                                status: scheduleDate ? 'pending' : 'completed',
                                description: `Transfert de fonds à ${recipient.name}`,
                                recipient_id: recipient.id,
                                created_at: new Date().toISOString(),
                                scheduled_at: scheduleDate || null,
                                is_recurring: isRecurring,
                                recurrence_interval: isRecurring ? recurrenceInterval : null
                            },
                            {
                                user_id: recipient.id,
                                amount: netAmount,
                                transaction_type: 'cash_transfer',
                                status: scheduleDate ? 'pending' : 'completed',
                                description: `Transfert reçu de ${userName}`,
                                recipient_id: userId,
                                created_at: new Date().toISOString(),
                                scheduled_at: scheduleDate || null,
                                is_recurring: isRecurring,
                                recurrence_interval: isRecurring ? recurrenceInterval : null
                            }
                        );
                    }

                    const { error } = await supabase
                        .from('transactions')
                        .insert(transactions);

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'cash_transfer',
                            amount: amount * recipientList.length,
                            status: scheduleDate ? 'pending' : 'completed',
                            description: `Transfert de fonds à ${recipientList.length} destinataires`,
                            scheduled_at: scheduleDate || null,
                            is_recurring: isRecurring,
                            recurrence_interval: isRecurring ? recurrenceInterval : null
                        }
                    });

                    showMessage('Transfert de fonds effectué avec succès !', 'success');
                    messageDiv.textContent = 'Transfert effectué avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('cashTransferForm').reset();
                    recipientList = [];
                    updateRecipientList();
                    scheduleOptions.classList.remove('active');
                    recurringOptions.classList.add('hidden');
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du transfert de fonds :', error);
                    showMessage(`Échec du transfert : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du transfert : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleDepositForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('depositSubmitBtn');
                submitBtn.disabled = true;
                const amount = parseFloat(document.getElementById('depositAmount').value);
                const messageDiv = document.getElementById('depositMessage');

                if (!amount || amount < 1) {
                    showMessage('Veuillez entrer un montant valide (minimum 1,00 $).', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const { paymentIntent, error: stripeError } = await stripe.createPaymentIntent({
                        amount: Math.round(amount * 100),
                        currency: 'usd',
                        payment_method_types: ['card'],
                    });

                    if (stripeError) {
                        showMessage(`Échec du dépôt : ${stripeError.message}`, 'error');
                        messageDiv.textContent = `Échec du dépôt : ${stripeError.message}`;
                        messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                        submitBtn.disabled = false;
                        return;
                    }

                    const { error: confirmError } = await stripe.confirmCardPayment(paymentIntent.client_secret, {
                        payment_method: { card: cardElement }
                    });

                    if (confirmError) {
                        showMessage(`Échec du dépôt : ${confirmError.message}`, 'error');
                        messageDiv.textContent = `Échec du dépôt : ${confirmError.message}`;
                        messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                        submitBtn.disabled = false;
                        return;
                    }

                    const { error } = await supabase
                        .from('transactions')
                        .insert({
                            user_id: userId,
                            amount: amount,
                            transaction_type: 'deposit',
                            status: 'completed',
                            description: 'Dépôt via Stripe',
                            created_at: new Date().toISOString()
                        });

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'deposit',
                            amount: amount,
                            status: 'completed',
                            description: 'Dépôt via Stripe'
                        }
                    });

                    showMessage('Dépôt effectué avec succès !', 'success');
                    messageDiv.textContent = 'Dépôt effectué avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('depositForm').reset();
                    cardElement.clear();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du dépôt :', error);
                    showMessage(`Échec du dépôt : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du dépôt : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleTransferForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('transferSubmitBtn');
                submitBtn.disabled = true;
                const recipientId = document.getElementById('transferRecipient').value;
                const amount = parseFloat(document.getElementById('transferAmount').value);
                const messageDiv = document.getElementById('transferMessage');

                if (!recipientId || !amount || amount < 0.01) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const { data: recipient, error: userError } = await supabase
                        .from('users')
                        .select('id, full_name')
                        .eq('id', recipientId)
                        .single();

                    if (userError || !recipient) {
                        showMessage('Destinataire non trouvé.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const balance = await getCalculatedBalance();
                    if (balance < amount) {
                        showMessage('Solde insuffisant pour effectuer ce transfert.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const netAmount = amount * (1 - TRANSACTION_FEE_RATE);
                    const { error } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: userId,
                                amount: -amount,
                                transaction_type: 'transfer',
                                status: 'completed',
                                description: `Transfert à ${recipient.full_name}`,
                                recipient_id: recipientId,
                                created_at: new Date().toISOString()
                            },
                            {
                                user_id: recipientId,
                                amount: netAmount,
                                transaction_type: 'transfer',
                                status: 'completed',
                                description: `Transfert reçu de ${userName}`,
                                recipient_id: userId,
                                created_at: new Date().toISOString()
                            }
                        ]);

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'transfer',
                            amount: amount,
                            status: 'completed',
                            description: `Transfert à ${recipient.full_name}`
                        }
                    });

                    showMessage('Transfert effectué avec succès !', 'success');
                    messageDiv.textContent = 'Transfert effectué avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('transferForm').reset();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du transfert :', error);
                    showMessage(`Échec du transfert : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du transfert : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleRequestForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('requestSubmitBtn');
                submitBtn.disabled = true;
                const senderId = document.getElementById('requestSender').value;
                const amount = parseFloat(document.getElementById('requestAmount').value);
                const messageDiv = document.getElementById('requestMessage');

                if (!senderId || !amount || amount < 0.01) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const { data: sender, error: userError } = await supabase
                        .from('users')
                        .select('id, full_name')
                        .eq('id', senderId)
                        .single();

                    if (userError || !sender) {
                        showMessage('Utilisateur non trouvé.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const { error } = await supabase
                        .from('transactions')
                        .insert({
                            user_id: userId,
                            amount: amount,
                            transaction_type: 'money_request',
                            status: 'pending',
                            description: `Demande d\'argent à ${sender.full_name}`,
                            recipient_id: senderId,
                            created_at: new Date().toISOString()
                        });

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'money_request',
                            amount: amount,
                            status: 'pending',
                            description: `Demande d\'argent à ${sender.full_name}`
                        }
                    });

                    showMessage('Demande d\'argent envoyée avec succès !', 'success');
                    messageDiv.textContent = 'Demande envoyée avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('requestForm').reset();
                    await Promise.all([fetchPendingRequests(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors de la demande d\'argent :', error);
                    showMessage(`Échec de la demande : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec de la demande : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            async function handleWithdrawalForm(e) {
                e.preventDefault();
                const submitBtn = document.getElementById('withdrawalSubmitBtn');
                submitBtn.disabled = true;
                const amount = parseFloat(document.getElementById('withdrawalAmount').value);
                const method = document.getElementById('withdrawalMethod').value;
                const account = document.getElementById('withdrawalAccount').value;
                const messageDiv = document.getElementById('withdrawalMessage');

                if (!amount || amount < 1 || !method || !account) {
                    showMessage('Veuillez remplir tous les champs obligatoires avec des valeurs valides.', 'error');
                    submitBtn.disabled = false;
                    return;
                }

                try {
                    const balance = await getCalculatedBalance();
                    if (balance < amount) {
                        showMessage('Solde insuffisant pour effectuer ce retrait.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }

                    const { error } = await supabase
                        .from('transactions')
                        .insert({
                            user_id: userId,
                            amount: -amount,
                            transaction_type: 'withdrawal',
                            status: 'pending',
                            description: `Retrait via ${method} vers ${account}`,
                            created_at: new Date().toISOString()
                        });

                    if (error) throw error;

                    await supabase.functions.invoke('send-transaction-email', {
                        body: {
                            user_id: userId,
                            transaction_type: 'withdrawal',
                            amount: amount,
                            status: 'pending',
                            description: `Retrait via ${method} vers ${account}`
                        }
                    });

                    showMessage('Demande de retrait envoyée avec succès !', 'success');
                    messageDiv.textContent = 'Demande de retrait envoyée avec succès !';
                    messageDiv.className = 'text-green-500 text-[0.867rem] text-center mt-4';
                    document.getElementById('withdrawalForm').reset();
                    await Promise.all([fetchWalletBalance(), fetchTransactionHistory()]);
                } catch (error) {
                    console.error('Erreur lors du retrait :', error);
                    showMessage(`Échec du retrait : ${error.message}`, 'error');
                    messageDiv.textContent = `Échec du retrait : ${error.message}`;
                    messageDiv.className = 'text-red-500 text-[0.867rem] text-center mt-4';
                } finally {
                    submitBtn.disabled = false;
                }
            }

            // View Pending Requests
            document.getElementById('viewPendingRequestsBtn').addEventListener('click', () => {
                const pendingRequestsCard = document.getElementById('pendingRequestsContainer');
                pendingRequestsCard.scrollIntoView({ behavior: 'smooth' });
                const content = document.getElementById('pendingRequestsContent');
                const icon = pendingRequestsCard.querySelector('.card-header i');
                content.classList.add('open');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            });

            // Form Event Listeners
            document.getElementById('payBillForm').addEventListener('submit', handlePayBillForm);
            document.getElementById('retailAgentWithdrawalForm')?.addEventListener('submit', handleRetailAgentWithdrawalForm);
            document.getElementById('retailAgentDepositForm')?.addEventListener('submit', handleRetailAgentDepositForm);
            document.getElementById('qrDepositForm')?.addEventListener('submit', handleQrDepositForm);
            document.getElementById('qrWithdrawalForm')?.addEventListener('submit', handleQrWithdrawalForm);
            document.getElementById('cashTransferForm')?.addEventListener('submit', handleCashTransferForm);
            document.getElementById('depositForm').addEventListener('submit', handleDepositForm);
            document.getElementById('transferForm').addEventListener('submit', handleTransferForm);
            document.getElementById('requestForm').addEventListener('submit', handleRequestForm);
            document.getElementById('withdrawalForm').addEventListener('submit', handleWithdrawalForm);

            // Autocomplete Event Listeners
            document.getElementById('billBusinessPartner').addEventListener('input', handleBusinessPartnerSearch);
            document.getElementById('transferRecipient').addEventListener('input', handleRecipientSearch);
            document.getElementById('requestSender').addEventListener('input', handleSenderSearch);
            document.getElementById('cashTransferRecipient')?.addEventListener('input', handleCashTransferSearch);

            // Initial Data Fetch
            await Promise.all([fetchWalletBalance(), fetchPendingRequests(), fetchTransactionHistory()]);
        });
    </script>
</body>
</html>