<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - nova7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #F0F2F5;
        color: #1a202c;
      }
      .header-nova7 {
        background-color: #FFFFFF;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 0.75rem 1.5rem;
        height: 60px;
      }
      .nova7-logo-header {
        max-height: 36px;
        width: auto;
      }
      .sidebar-nova7 {
        background-color: #004182;
        color: #E0F2FE;
        width: 260px;
        box-shadow: 2px 0 8px rgba(0,0,0,0.15);
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        padding-top: 1rem;
        transition: transform 0.3s ease-in-out;
        z-index: 40;
        display: flex;
        flex-direction: column;
      }
      .sidebar-header {
        padding: 0.75rem 1.5rem 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom: 1px solid #0053a0;
        margin-bottom: 0.75rem;
      }
      .sidebar-logo-img {
        max-height: 120px;
        width: auto;
      }
      .sidebar-nova7 .nav-link-sidebar {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        margin: 0.25rem 1rem;
        font-weight: 500;
        color: #E0F2FE;
        transition: background-color 0.2s, color 0.2s;
      }
      .sidebar-nova7 .nav-link-sidebar:hover {
        background-color: #0A66C2;
        color: #FFFFFF;
      }
      .sidebar-nova7 .nav-link-sidebar.active {
        background-color: #FFFFFF;
        color: #0A66C2;
        font-weight: 600;
      }
      .sidebar-nova7 .nav-link-sidebar i {
        width: 20px;
        margin-right: 0.75rem;
        text-align: center;
      }
      .main-content-area {
        margin-left: 260px;
        padding: 1.5rem;
        width: calc(100% - 260px);
        min-height: 100vh;
      }
      .metric-card {
        background-color: #FFFFFF;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.07);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 140px;
      }
      .metric-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      .metric-card-header h2 {
        font-size: 0.95rem;
        font-weight: 600;
        color: #4A5568;
      }
      .metric-card-icon {
        font-size: 1.5rem;
      }
      .metric-card-value {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
      }
      .metric-card-footer {
        font-size: 0.75rem;
        color: #718096;
        margin-top: auto;
      }
      .chart-placeholder-container {
        background-color: #FFFFFF;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.07);
        padding: 1.5rem;
        min-height: 300px;
        display: flex;
        flex-direction: column;
      }
      .chart-placeholder-container h3 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2D3748;
        margin-bottom: 1rem;
      }
      .chart-placeholder-content {
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed #E2E8F0;
        border-radius: 8px;
        color: #A0AEC0;
      }
      .mobile-header {
        display: none;
      }
      .greeting-summary-card {
        background-color: #FFFFFF;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.07);
        padding: 1.5rem 2rem;
        margin-bottom: 1.5rem;
      }
      .greeting-text {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2D3748;
        margin-bottom: 0.5rem;
      }
      .ai-summary-text {
        font-size: 0.95rem;
        color: #4A5568;
        line-height: 1.6;
      }
      .ai-summary-text strong {
        color: #004182;
        font-weight: 600;
      }
      .btn-resend {
        background-color: #0A66C2;
        color: white;
        border-radius: 20px;
        padding: 8px 16px;
        font-weight: 600;
        transition: background-color 0.2s;
        border: none;
        cursor: pointer;
      }
      .btn-resend:hover {
        background-color: #004182;
      }
      .btn-resend:disabled {
        background-color: #A0AEC0;
        cursor: not-allowed;
      }
      @media (max-width: 1024px) {
        .lg\:grid-cols-5 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 768px) {
        .sidebar-nova7 {
          transform: translateX(-100%);
          top: 0;
          height: 100vh;
        }
        .sidebar-nova7.open {
          transform: translateX(0);
        }
        .main-content-area {
          margin-left: 0;
          width: 100%;
          padding-top: calc(60px + 1rem);
        }
        .desktop-header {
          display: none;
        }
        .mobile-header {
          display: flex;
          background-color: #FFFFFF;
          box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
          padding: 0 1rem;
          height: 60px;
          align-items: center;
          justify-content: space-between;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 50;
        }
        .greeting-text {
          font-size: 1.25rem;
        }
        .lg\:grid-cols-5 {
          grid-template-columns: repeat(1, minmax(0, 1fr));
        }
      }
    </style>
  </head>
  <body class="flex flex-col min-h-screen">
    <header class="mobile-header md:hidden">
      <button id="hamburgerBtnMobile" class="p-2 text-gray-700 hover:text-blue-600">
        <i class="fas fa-bars text-2xl"></i>
      </button>
      <a href="dashboard.html">
        <img src="nova-logo.png" alt="Logo nova7" class="nova7-logo-header"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
        <span style="display:none;" class="text-xl font-semibold text-gray-700">nova7</span>
      </a>
      <a href="#" id="mobileLogoutLink" class="p-2 text-gray-700 hover:text-blue-600">
        <i class="fas fa-sign-out-alt text-xl"></i>
      </a>
    </header>
    <aside id="sidebar" class="sidebar-nova7">
      <div class="sidebar-header">
        <a href="dashboard.html" class="flex items-center">
          <img src="nova-logo.png" alt="Logo nova7" class="sidebar-logo-img"
               style="filter: brightness(0) invert(1);"
               onerror="this.style.display='none';">
        </a>
      </div>
      <nav class="flex-grow">
        <a href="dashboard.html" class="nav-link-sidebar active">
          <i class="fas fa-tachometer-alt"></i>Tableau de bord
        </a>
        <a href="view-transactions.html" class="nav-link-sidebar">
          <i class="fas fa-exchange-alt"></i>Transactions
        </a>
        <a href="reports.html" class="nav-link-sidebar">
          <i class="fas fa-chart-pie"></i>Rapports
        </a>
        <a href="community.html" class="nav-link-sidebar">
          <i class="fas fa-users"></i>Communauté
        </a>
        <a href="chatbot.html" class="nav-link-sidebar">
          <i class="fas fa-comments-dollar"></i>Conseiller Virtuel
        </a>
        <a href="resources.html" class="nav-link-sidebar">
          <i class="fas fa-book-open"></i>Ressources
        </a>
        <a href="settings.html" class="nav-link-sidebar">
          <i class="fas fa-cog"></i>Paramètres
        </a>
        <a href="wallet.html" class="nav-link-sidebar">
          <i class="fas fa-wallet"></i>Portefeuille
        </a>
        <a href="marketplace.html" class="nav-link-sidebar">
          <i class="fas fa-store"></i>Marché
        </a>
      </nav>
      <div class="pb-4">
        <a href="profile.html" class="nav-link-sidebar">
          <i class="fas fa-user-circle"></i>Profil
        </a>
        <a href="#" id="sidebarLogoutLink" class="nav-link-sidebar">
          <i class="fas fa-sign-out-alt"></i>Déconnexion
        </a>
      </div>
    </aside>
    <main class="main-content-area">
      <header class="desktop-header hidden md:flex items-center justify-between mb-6">
        <div></div>
        <div class="flex items-center space-x-3">
          <span id="desktopUserWelcome" class="text-sm text-gray-700">Bienvenue, Utilisateur!</span>
        </div>
      </header>
      <div id="verificationMessage" class="greeting-summary-card hidden">
        <h1 class="greeting-text">Veuillez vérifier votre courriel</h1>
        <p class="ai-summary-text">
          Votre compte n'est pas encore vérifié. Veuillez consulter votre courriel pour le lien de vérification.
          <button id="resendVerification" class="btn-resend mt-4">Renvoyer le courriel de vérification</button>
        </p>
      </div>
      <div id="dashboardContent" class="hidden">
        <div class="greeting-summary-card">
          <h1 id="personalizedGreeting" class="greeting-text">Bonjour, Utilisateur!</h1>
          <p class="ai-summary-text" id="aiSummaryText">
            Chargement de votre sommaire financier...
          </p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-6">
          <div class="metric-card">
            <div>
              <div class="metric-card-header">
                <h2>Revenus totaux</h2>
                <i class="fas fa-dollar-sign metric-card-icon text-green-500"></i>
              </div>
              <p class="metric-card-value text-green-600" id="totalIncomeDisplay">0,00 $</p>
            </div>
            <p class="metric-card-footer">Cette période</p>
          </div>
          <div class="metric-card">
            <div>
              <div class="metric-card-header">
                <h2>Dépenses totales</h2>
                <i class="fas fa-receipt metric-card-icon text-red-500"></i>
              </div>
              <p class="metric-card-value text-red-600" id="totalExpensesDisplay">0,00 $</p>
            </div>
            <p class="metric-card-footer">Cette période</p>
          </div>
          <div class="metric-card">
            <div>
              <div class="metric-card-header">
                <h2>Solde net</h2>
                <i class="fas fa-balance-scale-right metric-card-icon text-blue-500"></i>
              </div>
              <p class="metric-card-value text-blue-600" id="netBalanceDisplay">0,00 $</p>
            </div>
            <p class="metric-card-footer">Cette période</p>
          </div>
          <div class="metric-card">
            <div>
              <div class="metric-card-header">
                <h2>Marge de profit</h2>
                <i class="fas fa-percentage metric-card-icon text-purple-500"></i>
              </div>
              <p class="metric-card-value text-purple-600" id="profitMarginDisplay">0%</p>
            </div>
            <p class="metric-card-footer">Cette période</p>
          </div>
          <div class="metric-card">
            <div>
              <div class="metric-card-header">
                <h2>Factures en retard</h2>
                <i class="fas fa-file-invoice-dollar metric-card-icon text-orange-500"></i>
              </div>
              <p class="metric-card-value text-orange-600" id="overdueInvoicesDisplay">0,00 $</p>
            </div>
            <p class="metric-card-footer">(<span id="overdueInvoicesCount">0</span>) Total impayé</p>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <div class="chart-placeholder-container">
            <h3>Tendance des ventes (Graphique à barres)</h3>
            <canvas id="salesTrendChart" width="400" height="200"></canvas>
          </div>
          <div class="chart-placeholder-container">
            <h3>Répartition des dépenses (Graphique en anneau)</h3>
            <canvas id="expenseBreakdownChart" width="400" height="200"></canvas>
          </div>
        </div>
        <div class="chart-placeholder-container">
          <h3>Flux de trésorerie (Graphique en aires)</h3>
          <canvas id="cashFlowChart" width="400" height="200"></canvas>
        </div>
      </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      document.addEventListener('DOMContentLoaded', async function() {
        // Initialize Supabase client
        const SUPABASE_URL = 'https://nvxqorudztbpwyanakdj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52eHFvcnVkenRicHd5YW5ha2RqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzOTk5NTQsImV4cCI6MjA2Nzk3NTk1NH0.XvITDAnpEkjQTh4SCVOfwGKsaANS6tp58Up37SXwYRw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const TRANSACTION_FEE_RATE = 0.001; // 0.1% fee
        console.log("Client Supabase initialisé.");

        const aiSummaryText = document.getElementById('aiSummaryText');
        const verificationMessage = document.getElementById('verificationMessage');
        const dashboardContent = document.getElementById('dashboardContent');
        const resendButton = document.getElementById('resendVerification');
        let userName = "Utilisateur";
        let userId = null;
        let recentTransactions = [];

        // Format currency for Quebec/Canada (French)
        function formatCurrency(value) {
          const number = Number(value) || 0;
          return number.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
        }

        // Show message function
        function showMessage(element, message, type = 'success') {
          element.innerHTML = message;
          element.className = `ai-summary-text ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
        }

        // Handle logout
        async function handleLogout() {
          console.log("Tableau de bord : Déconnexion et redirection vers login.html");
          await supabase.auth.signOut();
          window.location.href = 'login.html';
        }

        const sidebarLogoutLink = document.getElementById('sidebarLogoutLink');
        if (sidebarLogoutLink) sidebarLogoutLink.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
        const mobileLogoutLink = document.getElementById('mobileLogoutLink');
        if (mobileLogoutLink) mobileLogoutLink.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });

        // Mobile sidebar toggle
        const hamburgerBtnMobile = document.getElementById('hamburgerBtnMobile');
        const sidebar = document.getElementById('sidebar');
        if (hamburgerBtnMobile && sidebar) {
          hamburgerBtnMobile.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('open'); });
        }
        document.addEventListener('click', (e) => {
          if (sidebar && sidebar.classList.contains('open') && !sidebar.contains(e.target) && (!hamburgerBtnMobile || !hamburgerBtnMobile.contains(e.target))) {
            sidebar.classList.remove('open');
          }
        });

        // Fetch user session
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError || !session) {
          console.log("Tableau de bord : Aucune session Supabase active. Redirection vers la connexion.");
          handleLogout();
          return;
        }

        const user = session.user;
        userId = user.id;
        console.log("Utilisateur Supabase:", user);

        // Check email verification
        if (user && !user.email_confirmed_at && user.email) {
          verificationMessage.classList.remove('hidden');
          dashboardContent.classList.add('hidden');
          showMessage(
            verificationMessage.querySelector('.ai-summary-text'),
            `Votre compte n'est pas encore vérifié. Veuillez consulter votre courriel (${user.email}) pour le lien de vérification.`,
            'error'
          );

          if (resendButton) {
            resendButton.addEventListener('click', async () => {
              resendButton.disabled = true;
              resendButton.textContent = 'Envoi en cours...';
              try {
                const { error } = await supabase.auth.resend({
                  type: 'signup',
                  email: user.email,
                  options: { emailRedirectTo: 'http://www.lifeline-wdc.com/email-verification.html' }
                });
                if (error) {
                  console.error('Erreur de renvoi:', error.message);
                  showMessage(
                    verificationMessage.querySelector('.ai-summary-text'),
                    `Échec du renvoi du courriel de vérification : ${error.message}`,
                    'error'
                  );
                } else {
                  showMessage(
                    verificationMessage.querySelector('.ai-summary-text'),
                    `Courriel de vérification renvoyé à ${user.email}`,
                    'success'
                  );
                }
              } catch (err) {
                console.error('Erreur de renvoi inattendue:', err);
                showMessage(
                  verificationMessage.querySelector('.ai-summary-text'),
                  'Erreur inattendue. Veuillez réessayer.',
                  'error'
                );
              } finally {
                resendButton.disabled = false;
                resendButton.textContent = 'Renvoyer le courriel de vérification';
              }
            });
          }
          return;
        }

        verificationMessage.classList.add('hidden');
        dashboardContent.classList.remove('hidden');

        try {
          // Fetch user profile
          const { data: profile, error: profileError } = await supabase
            .from('users')
            .select('full_name')
            .eq('id', user.id)
            .maybeSingle();

          if (profileError) {
            console.error('Erreur lors de la récupération du profil utilisateur:', profileError.message);
            userName = "Utilisateur";
          } else {
            userName = profile?.full_name || "Utilisateur";
          }

          // Update greeting
          const greetingElement = document.getElementById('personalizedGreeting');
          const desktopUserWelcomeElement = document.getElementById('desktopUserWelcome');
          if (greetingElement) {
            const currentHour = new Date().getHours();
            let timeOfDayGreeting = "Bonjour";
            if (currentHour >= 18) timeOfDayGreeting = "Bonsoir";
            greetingElement.textContent = `${timeOfDayGreeting}, ${userName}!`;
          }
          if (desktopUserWelcomeElement) desktopUserWelcomeElement.textContent = `Bienvenue, ${userName}!`;

          // Fetch transactions with product_id validation
          const { data: transactions, error: transactionsError } = await supabase
            .from('transactions')
            .select('id, amount, transaction_type, created_at, user_id, recipient_id, product_id, status')
            .or(`user_id.eq.${user.id},recipient_id.eq.${user.id}`)
            .eq('status', 'completed')
            .order('created_at', { ascending: false })
            .limit(100);

          if (transactionsError) {
            console.error('Erreur lors de la récupération des transactions:', transactionsError.message);
            showMessage(aiSummaryText, "Impossible de charger les données des transactions. Veuillez vérifier les politiques RLS.", 'error');
            recentTransactions = [];
          } else {
            // Filter valid product_buy transactions
            recentTransactions = transactions.filter(t => {
              if (t.transaction_type === 'product_buy' && t.user_id === userId) {
                return t.product_id && transactions.some(t2 => 
                  t2.transaction_type === 'product_sell' && 
                  t2.product_id === t.product_id && 
                  t2.status === 'completed' && 
                  new Date(t2.created_at) >= new Date(t.created_at) && 
                  new Date(t2.created_at) <= new Date(t.created_at).setMinutes(new Date(t.created_at).getMinutes() + 1)
                );
              }
              return true;
            });
          }

          // Calculate financial metrics
          let totalIncome = 0;
          let totalExpenses = 0;
          recentTransactions.forEach(t => {
            const amount = parseFloat(t.amount) || 0;
            if (t.user_id === userId && ['deposit', 'product_sell', 'loan_received'].includes(t.transaction_type)) {
              totalIncome += amount;
            } else if (t.transaction_type === 'transfer' && t.recipient_id === userId) {
              totalIncome += amount * (1 - TRANSACTION_FEE_RATE);
            } else if (t.transaction_type === 'money_request' && t.user_id === userId && t.status === 'completed') {
              totalIncome += amount;
            } else if (t.user_id === userId && ['withdrawal', 'bill_payment', 'loan_payment', 'insurance_payment', 'product_buy'].includes(t.transaction_type)) {
              totalExpenses += Math.abs(amount);
            }
          });
          const userBalance = totalIncome - totalExpenses;

          document.getElementById('totalIncomeDisplay').textContent = formatCurrency(totalIncome);
          document.getElementById('totalExpensesDisplay').textContent = formatCurrency(totalExpenses);
          document.getElementById('netBalanceDisplay').textContent = formatCurrency(userBalance);

          let profitMargin = 0;
          if (totalIncome > 0) {
            profitMargin = ((totalIncome - totalExpenses) / totalIncome) * 100;
          }
          document.getElementById('profitMarginDisplay').textContent = `${profitMargin.toFixed(1).replace('.', ',')}%`;

          document.getElementById('overdueInvoicesDisplay').textContent = formatCurrency(0);
          document.getElementById('overdueInvoicesCount').textContent = `0`;

          // Update AI summary
          if (aiSummaryText) {
            let summaryMessage = `Votre solde net actuel est de <strong>${formatCurrency(userBalance)}</strong>. `;
            if (totalIncome > totalExpenses) {
              summaryMessage += `Vous êtes rentable avec une marge de <strong>${profitMargin.toFixed(1).replace('.', ',')}%</strong>. Continuez votre bon travail !`;
            } else if (totalExpenses > 0) {
              summaryMessage += `Vous avez dépensé plus que vous n'avez gagné cette période. Révisez vos dépenses.`;
            } else {
              summaryMessage += `Commencez par ajouter des transactions de revenus et de dépenses pour voir votre portrait financier.`;
            }
            aiSummaryText.innerHTML = summaryMessage;
          }

          // Render charts
          renderSalesTrendChart(recentTransactions);
          renderExpenseBreakdownChart(recentTransactions);
          renderCashFlowChart(recentTransactions);

        } catch (error) {
          console.error("Tableau de bord : Erreur lors de la récupération des données de Supabase:", error);
          showMessage(aiSummaryText, "Échec du chargement des données du tableau de bord. Veuillez réessayer.", 'error');
        }

        // Render sales trend chart
        function renderSalesTrendChart(transactions) {
          const salesData = transactions.filter(t => t.transaction_type === 'product_sell' && t.recipient_id === userId);
          const labels = salesData.map(t => new Date(t.created_at).toLocaleDateString('fr-CA'));
          const data = salesData.map(t => parseFloat(t.amount));
          const ctx = document.getElementById('salesTrendChart').getContext('2d');
          if (window.salesTrendChartInstance) window.salesTrendChartInstance.destroy();
          window.salesTrendChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Ventes',
                data: data,
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: { scales: { y: { beginAtZero: true } } }
          });
        }

        // Render expense breakdown chart
        function renderExpenseBreakdownChart(transactions) {
          const expenseData = transactions.filter(t => 
            t.user_id === userId && 
            (['product_buy', 'transfer_sent', 'insurance_payment'].includes(t.transaction_type) || t.transaction_type.startsWith('withdrawal')) &&
            (t.transaction_type !== 'product_buy' || 
             (t.product_id && transactions.some(t2 => 
               t2.transaction_type === 'product_sell' && 
               t2.product_id === t.product_id && 
               t2.status === 'completed' && 
               new Date(t2.created_at) >= new Date(t.created_at) && 
               new Date(t2.created_at) <= new Date(t.created_at).setMinutes(new Date(t.created_at).getMinutes() + 1)
             ))
            )
          );
          const categories = {
            'Achat de produit': 'product_buy',
            'Retrait': 'withdrawal',
            'Transfert envoyé': 'transfer_sent',
            'Paiement d\'assurance': 'insurance_payment'
          };
          const data = Object.values(categories).map(catKey => {
            return expenseData.filter(t => {
              const normalizedType = t.transaction_type.toLowerCase().replace(/ /g, '_');
              if (catKey === 'withdrawal') return normalizedType.startsWith('withdrawal');
              return normalizedType === catKey;
            }).reduce((sum, t) => sum + Math.abs(parseFloat(t.amount)), 0);
          });
          const ctx = document.getElementById('expenseBreakdownChart').getContext('2d');
          if (window.expenseBreakdownChartInstance) window.expenseBreakdownChartInstance.destroy();
          window.expenseBreakdownChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: Object.keys(categories),
              datasets: [{
                label: 'Dépenses',
                data: data,
                backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)', 'rgba(153, 102, 255, 0.6)'],
                borderColor: ['rgba(255, 99, 132, 1)', 'rgba(54, 162, 235, 1)', 'rgba(255, 206, 86, 1)', 'rgba(153, 102, 255, 1)'],
                borderWidth: 1
              }]
            },
            options: { responsive: true, plugins: { legend: { position: 'top' } } }
          });
        }

        // Render cash flow chart
        function renderCashFlowChart(transactions) {
          const cashFlowData = transactions.filter(t => {
            if (t.transaction_type === 'product_buy' && t.user_id === userId) {
              return t.product_id && transactions.some(t2 => 
                t2.transaction_type === 'product_sell' && 
                t2.product_id === t.product_id && 
                t2.status === 'completed' && 
                new Date(t2.created_at) >= new Date(t.created_at) && 
                new Date(t2.created_at) <= new Date(t.created_at).setMinutes(new Date(t.created_at).getMinutes() + 1)
              );
            }
            return true;
          }).map(t => ({
            date: new Date(t.created_at),
            amount: parseFloat(t.amount)
          })).sort((a, b) => a.date - b.date);

          const aggregatedCashFlow = cashFlowData.reduce((acc, current) => {
            const dateKey = current.date.toLocaleDateString('fr-CA');
            if (!acc[dateKey]) {
              acc[dateKey] = { inflow: 0, outflow: 0 };
            }
            if (current.amount > 0 && (current.user_id === userId || ['transfer'].includes(current.transaction_type))) {
              acc[dateKey].inflow += current.amount;
            } else if (current.amount < 0 && current.user_id === userId) {
              acc[dateKey].outflow += Math.abs(current.amount);
            }
            return acc;
          }, {});

          const labels = Object.keys(aggregatedCashFlow);
          const inflowData = labels.map(label => aggregatedCashFlow[label].inflow);
          const outflowData = labels.map(label => aggregatedCashFlow[label].outflow);

          const ctx = document.getElementById('cashFlowChart').getContext('2d');
          if (window.cashFlowChartInstance) window.cashFlowChartInstance.destroy();
          window.cashFlowChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [
                {
                  label: 'Entrées',
                  data: inflowData,
                  fill: true,
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  tension: 0.1
                },
                {
                  label: 'Sorties',
                  data: outflowData,
                  fill: true,
                  backgroundColor: 'rgba(255, 99, 132, 0.2)',
                  borderColor: 'rgba(255, 99, 132, 1)',
                  tension: 0.1
                }
              ]
            },
            options: { scales: { y: { beginAtZero: true } } }
          });
        }
      });
    </script>
  </body>
</html>